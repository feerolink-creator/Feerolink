<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>FeeroLink Viewer - タグスコア強化版</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    #cy {
      width: 100%;
      height: 500px;
      border: 1px solid #aaa;
    }
    #controls, #info {
      margin-top: 10px;
      font-family: sans-serif;
    }
    input[type="text"] {
      margin-right: 10px;
    }
  </style>
</head>
<body>

<h2>FeeroLink Viewer - タグスコア強化版</h2>

<div id="controls">
  <label>タイトル：</label>
  <input type="text" id="title" />
  <label>説明：</label>
  <input type="text" id="description" size="40" />
  <label>タグ（カンマ区切り）：</label>
  <input type="text" id="tag" />
  <button onclick="addNode()">ノード追加＋自動接続</button>
</div>

<div id="cy"></div>
<div id="info">ノードをクリックすると、説明がここに表示されます。</div>

<script>
  let descriptions = {
    "stellar": "尊厳が守られている世界の、優しさ、尊さを表せているように思ってきた。この子は、暴力から守られている。やわらかな時間の中にいる。",
    "grief": "誰にも見つからず、奥底で静かに降り積もる感情。"
  };

  let tags = {
    "stellar": ["尊厳", "非暴力", "静的時間"],
    "grief": ["喪失", "静寂", "孤独"]
  };

  const threshold = 0.3;

  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [
      { data: { id: 'stellar', label: 'stellar', tag: '尊厳' } },
      { data: { id: 'grief', label: 'grief', tag: '喪失' } }
    ],
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'background-color': '#88ccff',
          'text-valign': 'center',
          'text-halign': 'center'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': function(ele) {
            const score = ele.data('weight') || 0.5;
            return 6 * (1 - score);
          },
          'line-color': '#bbb',
          'curve-style': 'bezier'
        }
      }
    ],
    layout: {
      name: 'grid',
      rows: 1
    }
  });

  cy.on('tap', 'node', function(evt){
    const id = evt.target.id();
    const desc = descriptions[id] || "説明なし";
    const tag = tags[id] ? tags[id].join(', ') : "タグなし";
    document.getElementById('info').innerText = `[${id}] ${desc}（タグ: ${tag}）`;
  });

  function addNode() {
    const title = document.getElementById('title').value.trim();
    const desc = document.getElementById('description').value.trim();
    const tagStr = document.getElementById('tag').value.trim();
    if (!title || cy.getElementById(title).length > 0) {
      alert("タイトルが空か、すでに存在しています");
      return;
    }

    const tagArr = tagStr.split(',').map(t => t.trim());
    descriptions[title] = desc;
    tags[title] = tagArr;

    cy.add({ data: { id: title, label: title, tag: tagArr.join(',') } });

    for (let id in tags) {
      if (id === title) continue;
      const overlap = tags[title].filter(t => tags[id].includes(t));
      const union = new Set([...tags[title], ...tags[id]]);
      const score = 1 - (overlap.length / union.size);
      if (score < threshold) {
        cy.add({ data: { id: `e_${title}_${id}`, source: title, target: id, weight: score } });
      }
    }

    cy.layout({ name: 'grid', rows: 1 }).run();
  }
</script>

</body>
</html>
